<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SOIL MONITORING DASHBOARD</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3498db">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    #aboutBtn {
      display: block;
      margin: 50px auto 0 auto;
      font-size: 14px;
      padding: 6px 20px 6px;
      border: none;
      border-radius: 10px;
      background: #046168;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }

    #aboutBtn:hover {
      background: #31baf0;
    }

    /* Modal styling */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.6);
    }

    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      border-radius: 12px;
      width: 360px;
      max-height: 80vh;
      /* limit height to viewport */
      overflow-y: auto;
      /* scroll inside modal only */
      text-align: left;
      font-size: 14px;
      line-height: 1.5;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: #000;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1E93AB;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    .dashboard {
      background: #DCDCDC;
      padding: 15px 50px 10px;
      border-radius: 20px;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.25);
      text-align: center;
      width: 480px;
      max-width: 95%;
    }

    h1 {
      color: #000000;
      font-size: 32px;
      text-transform: uppercase;
      margin-bottom: 0px;
    }

    h2 {
      color: #000000;
      text-align: center;
      margin-top: 0;
      margin-bottom: 40px;
      font-size: 28px;
    }

    .bar-title {
      margin-top: 10px;
      font-size: 20px;
      font-weight: bold;
      color: #34495e;
    }

    .gauge-row {
      display: flex;
      justify-content: space-evenly;
      align-items: flex-end;
      gap: 5px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .gauge-row>div {
      text-align: center;
    }

    .moisture-canvas,
    .temp-canvas {
      display: block;
    }

    .moisture-canvas {
      width: 250px;
      height: 250px;
    }

    .temp-canvas {
      width: 100px;
      height: 250px;
    }

    .status-label {
      font-weight: bold;
      font-size: 12px;
    }

    .status-value {
      font-size: 12px;
    }

    .status div {
      margin-bottom: 1px;
      line-height: 1.2;
    }

    .input-group {
      margin-bottom: 10px;
      line-height: 1.2 em;
    }

    input {
      padding: 8px;
      width: 140px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      text-align: center;
    }

    button.send {
      padding: 8px 16px;
      border: none;
      border-radius: 25px;
      background: #2980b9;
      color: #fff;
      font-weight: bold;
      font-size: 15px;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    button.send:hover {
      background: #3498db;
    }

    .buttons {
      display: flex;
      justify-content: space-around;
      gap: 20px;
      margin-top: 40px;
    }

    button#sprinklerBtn {
      padding: 15px 30px;
      border: none;
      border-radius: 18px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      color: #fff;
      flex: 1;
      background-color: #27ae60;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    button#sprinklerBtn:hover {
      opacity: 0.9;
    }

    footer {
      margin-top: 20px;
      font-size: 14px;
      color: #555;
    }

    .gauge-row>div:last-child .bar-title {
      margin-left: -8px;
    }

    @media (max-width:600px) {
      .dashboard {
        padding: 20px 0% 10px;
      }

      .buttons {
        flex-direction: column;
        gap: 15px;
      }

      button#sprinklerBtn {
        margin: 0 auto;
        width: 80%;
        display: block;
      }

      .gauge-row {
        flex-direction: row;
        gap: 5px;
        justify-content: center;
        align-items: flex-end;
      }

      .moisture-canvas {
        width: 180px;
        height: 180px;
      }

      .temp-canvas {
        width: 70px;
        height: 180px;
      }

      .gauge-row .bar-title {
        font-size: 16px;
      }
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <h1 style="text-align:center; margin-bottom: 0;">SOIL MONITORING</h1>
    <h2>Dashboard</h2>

    <div class="gauge-row">
      <div>
        <canvas id="moistureCanvas" class="moisture-canvas" width="250" height="250"></canvas>
        <div class="bar-title">Moisture</div>
      </div>
      <div>
        <canvas id="tempCanvas" class="temp-canvas" width="100" height="250"></canvas>
        <div class="bar-title">Temperature</div>
      </div>
    </div>

    <div class="status">
      <div><span class="status-label">System Status:</span> <span id="systemStatus" class="status-value"
          style="color:blue;">Unknown</span></div>
      <div><span class="status-label">Server Status:</span> <span id="mqttStatus" class="status-value"
          style="color:red;">Disconnected</span></div>
      <div><span class="status-label">Sprinkler Status:</span> <span id="pumpStatus" class="status-value">OFF</span>
      </div>
      <div><span class="status-label">Runtime:</span> <span id="runtime" class="status-value">0</span> sec</div>
      <div><span class="status-label">Threshold:</span> <span id="thresholdVal" class="status-value">85</span>%</div>
      <div><span class="status-label">Client ID:</span> <span id="clientIdText" class="status-value"></span></div>
    </div>

    <br />

    <div class="input-group">
      <input type="number" id="runtimeInput" placeholder="Runtime (sec)">
      <button class="send" onclick="sendRuntime()">Send</button>
    </div>

    <div class="input-group">
      <input type="number" id="thresholdInput" placeholder="Threshold (%)">
      <button class="send" onclick="sendThreshold()">Send</button>
    </div>

    <div class="buttons">
      <button id="sprinklerBtn">SPRINKLER</button>
    </div>
    <button id="aboutBtn">About</button>
  </div>
  <div id="aboutModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 style="text-align:center; margin-bottom:10px;">User Guide</h2>
      <hr>

      <h3>ðŸŒ± System Overview</h3>
      <p>
        The Soil Monitoring System measures <b>soil moisture</b> and <b>temperature</b>,
        and controls a <b>sprinkler pump</b> either automatically or manually.
        Data is displayed on this dashboard and synchronized through <b>IoT</b>.
      </p>

      <h3>ðŸ“Š Dashboard Features</h3>
      <ul>
        <li><b>Moisture Gauge:</b> Current soil moisture (%)</li>
        <li><b>Temperature Bar:</b> Current soil temperature (Â°C)</li>
        <li><b>System Status:</b> Device Online / Offline</li>
        <li><b>Server Status:</b> IoT connection Connected / Disconnected</li>
        <li><b>Sprinkler Status:</b> Pump ON / OFF</li>
        <li><b>Runtime:</b> Duration the pump runs (sec)</li>
        <li><b>Threshold:</b> Moisture % where watering stops</li>
        <li><b>Client ID:</b> Current web client identifier</li>
      </ul>

      <h3>ðŸŽ› Controls</h3>
      <ul>
        <li><b>Runtime Input:</b> Enter seconds â†’ <i>Send</i></li>
        <li><b>Threshold Input:</b> Enter % (1â€“100) â†’ <i>Send</i></li>
        <li><b>Sprinkler Button:</b><br>
          â€¢ Short press â†’ toggle ON/OFF (auto mode)<br>
          â€¢ Hold â†’ manual override (stays ON until released)
        </li>
      </ul>

      <h3>ðŸ”˜ Device Button (on ESP32)</h3>
      <ul>
        <li><b>1 click:</b> Toggle pump (auto mode)</li>
        <li><b>Long press:</b> Enable / disable manual override</li>
        <li><b>5 quick clicks:</b> Reset WiFi credentials â†’ starts AP mode on reboot</li>
      </ul>

      <hr>
      <p style="text-align:center; margin-top:10px; font-size:13px; color:#555;">
        Â© 2025 Created by Engr. Clariden MontaÃ±o
      </p>
    </div>
  </div>

  <script>
    const modal = document.getElementById("aboutModal");
    const btn = document.getElementById("aboutBtn");
    const span = document.querySelector(".close");

    btn.onclick = () => modal.style.display = "block";
    span.onclick = () => modal.style.display = "none";
    window.onclick = (event) => {
      if (event.target === modal) modal.style.display = "none";
    };
  </script>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const clientId = "WebClient" + Math.floor(Math.random() * 1000 + 1);
    document.getElementById("clientIdText").innerText = clientId;

    const client = mqtt.connect('wss://c33fda18bbcd4c9998277dfe166c7c4a.s1.eu.hivemq.cloud:8884/mqtt', {
      username: 'gwapooo',
      password: '_Mclards23',
      clientId: clientId,
      rejectUnauthorized: false
    });

    const topicJSON = "SoilSystem";
    const topicSprinkler = "Sprinkler";
    const topicSprinklerLong = "SprinklerLong";
    const topicRuntime = "Runtime";
    const topicLastWill = "Lastwill";

    const topicThreshold = "Threshold"; // NEW

    const thresholdElem = document.getElementById('thresholdVal');
    const thresholdInput = document.getElementById('thresholdInput');

    const mqttStatusElem = document.getElementById('mqttStatus');
    const systemStatusElem = document.getElementById('systemStatus');
    const pumpStatusElem = document.getElementById('pumpStatus');
    const runtimeElem = document.getElementById('runtime');
    const runtimeInput = document.getElementById('runtimeInput');

    let currentMoisture = 0, targetMoisture = 0;
    let currentTemp = 0, targetTemp = 0;

    // sprinkler UI state
    let sprinklerState = 0;

    client.on('connect', () => {
      mqttStatusElem.innerText = 'Connected';
      mqttStatusElem.style.color = 'green';
      client.subscribe(topicJSON);
      client.subscribe(topicLastWill);
      // optional: subscribe to Sprinkler to sync button with device
      client.subscribe(topicSprinkler);
      client.subscribe(topicThreshold); // NEW
    });

    client.on('close', () => { mqttStatusElem.innerText = 'Disconnected'; mqttStatusElem.style.color = 'red'; });
    client.on('offline', () => { mqttStatusElem.innerText = 'Offline'; mqttStatusElem.style.color = 'orange'; });
    client.on('error', () => { mqttStatusElem.innerText = 'Error'; mqttStatusElem.style.color = 'red'; });

    client.on('message', (topic, message) => {
      if (topic === topicJSON) {
        const data = JSON.parse(message.toString());
        targetMoisture = data.moisture;
        targetTemp = data.temperature;
        pumpStatusElem.innerText = data.pumpRunning ? "ON" : "OFF";
        runtimeElem.innerText = data.runtime;
        thresholdElem.innerText = data.threshold; // NEW
      } else if (topic === topicLastWill) {
        if (message.toString() === "System Online") {
          systemStatusElem.innerText = "Online";
          systemStatusElem.style.color = "green";
        } else {
          systemStatusElem.innerText = "Offline";
          systemStatusElem.style.color = "red";
        }
      } else if (topic === topicSprinkler) {
        // keep button color in sync if other clients toggle it
        const v = parseInt(message.toString(), 10) || 0;
        sprinklerState = v ? 1 : 0;
        sprinklerBtn.style.backgroundColor = sprinklerState ? "#27ae60" : "#c0392b";
      }
    });

    function sendRuntime() {
      const val = parseInt(runtimeInput.value);
      if (!isNaN(val) && val > 0) {
        client.publish(topicRuntime, val.toString(), { retain: true });
        runtimeElem.innerText = val;
        runtimeInput.value = '';
        systemStatusElem.innerText = `Runtime set to ${val}s`;
        systemStatusElem.style.color = "blue";

        // revert to lastwill after 2s
        setTimeout(() => {
          systemStatusElem.innerText = client.connected ? "Online" : "Offline";
          systemStatusElem.style.color = client.connected ? "green" : "red";
        }, 2000);
      } else {
        systemStatusElem.innerText = "Invalid runtime input";
        systemStatusElem.style.color = "red";
        setTimeout(() => {
          systemStatusElem.innerText = client.connected ? "Online" : "Offline";
          systemStatusElem.style.color = client.connected ? "green" : "red";
        }, 2000);
      }
    }

    function sendThreshold() {
      const val = parseInt(thresholdInput.value);
      if (!isNaN(val) && val > 0 && val <= 100) {
        client.publish(topicThreshold, val.toString(), { retain: true });
        thresholdElem.innerText = val;
        thresholdInput.value = '';
        systemStatusElem.innerText = `Threshold set to ${val}%`;
        systemStatusElem.style.color = "blue";

        // revert to lastwill after 2s
        setTimeout(() => {
          systemStatusElem.innerText = client.connected ? "Online" : "Offline";
          systemStatusElem.style.color = client.connected ? "green" : "red";
        }, 2000);
      } else {
        systemStatusElem.innerText = "Invalid threshold input (1â€“100%)";
        systemStatusElem.style.color = "red";
        setTimeout(() => {
          systemStatusElem.innerText = client.connected ? "Online" : "Offline";
          systemStatusElem.style.color = client.connected ? "green" : "red";
        }, 2000);
      }
    }


    // ---------- Robust press/hold using Pointer Events ----------
    const sprinklerBtn = document.getElementById("sprinklerBtn");
    const LONG_MS = 600;

    let pressTimer = null;
    let isPointerDown = false;
    let longPressActive = false;

    function startPress(e) {
      e.preventDefault();
      isPointerDown = true;
      longPressActive = false;

      clearTimeout(pressTimer);
      pressTimer = setTimeout(() => {
        if (!isPointerDown) return;        // guard: was released/cancelled
        longPressActive = true;
        client.publish(topicSprinklerLong, "1", { retain: true });
        sprinklerBtn.innerText = "HOLDINGâ€¦";
        sprinklerBtn.style.backgroundColor = "#e67e22";
      }, LONG_MS);
    }

    function endPress(e) {
      if (!isPointerDown) return;          // ignore hover/stray events
      e.preventDefault();
      clearTimeout(pressTimer);

      if (longPressActive) {
        // release the long hold
        client.publish(topicSprinklerLong, "0", { retain: true });
        longPressActive = false;
        sprinklerBtn.innerText = "SPRINKLER";
        sprinklerBtn.style.backgroundColor = sprinklerState ? "#27ae60" : "#c0392b";
      } else {
        // short click: toggle sprinkler
        sprinklerState = 1;
        client.publish(topicSprinkler, sprinklerState.toString(), { retain: true });
        pumpStatusElem.innerText = sprinklerState ? "ON" : "OFF";
        sprinklerBtn.style.backgroundColor = sprinklerState ? "#27ae60" : "#c0392b";
      }

      isPointerDown = false;
    }

    function cancelPress() {
      clearTimeout(pressTimer);
      isPointerDown = false;

      // if we had already started a hold, ensure it's released
      if (longPressActive) {
        client.publish(topicSprinklerLong, "0", { retain: true });
        longPressActive = false;
        sprinklerBtn.innerText = "SPRINKLER";
        sprinklerBtn.style.backgroundColor = sprinklerState ? "#27ae60" : "#c0392b";
      }
    }

    // Use only pointer events (prevents double mouse+touch firing)
    sprinklerBtn.addEventListener("pointerdown", startPress);
    sprinklerBtn.addEventListener("pointerup", endPress);
    sprinklerBtn.addEventListener("pointerleave", () => { if (isPointerDown) endPress(new Event('pointerup')); });
    sprinklerBtn.addEventListener("pointercancel", cancelPress);
    sprinklerBtn.oncontextmenu = (e) => e.preventDefault(); // stop long-press menu on mobile

    // ---------- Gauges ----------
    const canvas = document.getElementById('moistureCanvas');
    const ctx = canvas.getContext('2d');
    const radius = canvas.width / 2 - 20;

    const tempCanvas = document.getElementById('tempCanvas');
    const tctx = tempCanvas.getContext('2d');

    function interpolateColor(color1, color2, factor) {
      const result = color1.slice();
      for (let i = 0; i < 3; i++) result[i] = Math.round(result[i] + factor * (color2[i] - color1[i]));
      return result;
    }
    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
    }
    const dryColor = hexToRgb("#a0522d");
    const midColor = hexToRgb("#9acd32");
    const wetColor = hexToRgb("#1e90ff");
    function getMoistureColor(value) {
      if (value < 50) return interpolateColor(dryColor, midColor, value / 50);
      return interpolateColor(midColor, wetColor, (value - 50) / 50);
    }

    function drawMoisture() {
      const diff = targetMoisture - currentMoisture;
      currentMoisture += diff * 0.05;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const angle = (currentMoisture / 100) * 2 * Math.PI;

      const rgb = getMoistureColor(currentMoisture);
      const color = `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;

      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = '#eee';
      ctx.lineWidth = 30;
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, -Math.PI / 2, -Math.PI / 2 + angle);
      ctx.strokeStyle = color;
      ctx.lineWidth = 30;
      ctx.lineCap = 'round';
      ctx.stroke();

      ctx.fillStyle = '#111';
      ctx.font = 'bold 36px Segoe UI';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(Math.round(currentMoisture) + '%', centerX, centerY);

      requestAnimationFrame(drawMoisture);
    }

    function drawTemp() {
      const diff = targetTemp - currentTemp;
      currentTemp += diff * 0.05;

      tctx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);

      const gradient = tctx.createLinearGradient(0, tempCanvas.height - 20, 0, 0);
      gradient.addColorStop(0, "blue");
      gradient.addColorStop(1, "red");

      tctx.fillStyle = "#eee";
      tctx.fillRect(30, 0, 40, tempCanvas.height - 20);

      const fillHeight = (currentTemp / 50) * (tempCanvas.height - 20);
      tctx.fillStyle = gradient;
      tctx.fillRect(30, (tempCanvas.height - 20) - fillHeight, 40, fillHeight);

      tctx.fillStyle = "#111";
      tctx.font = "bold 16px Segoe UI";
      tctx.textAlign = "center";
      tctx.textBaseline = "top";
      tctx.fillText(Math.round(currentTemp) + "Â°C", tempCanvas.width / 2, tempCanvas.height - 18);

      requestAnimationFrame(drawTemp);
    }

    drawMoisture();
    drawTemp();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(() => console.log("Service Worker registered"));
    }
  </script>
</body>

</html>
