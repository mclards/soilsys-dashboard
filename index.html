<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SOIL MOISTURE CONTROL</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3498db">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1E93AB;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .dashboard {
      background: #DCDCDC;
      padding: 40px 50px;
      border-radius: 20px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.15);
      text-align: center;
      width: 480px;
      max-width: 95%;
    }
    h2 { color:#2c3e50; margin-bottom:40px; font-size:28px; text-transform:uppercase; }
    .bar-title { margin-top:10px; font-size:20px; font-weight:bold; color:#34495e; }
    .gauge-row { display:flex; justify-content:space-evenly; align-items:flex-end; gap:5px; margin-bottom:20px; flex-wrap:wrap; }
    .gauge-row>div { text-align:center; }
    .moisture-canvas, .temp-canvas { display:block; }
    .moisture-canvas { width:250px; height:250px; }
    .temp-canvas { width:100px; height:250px; }
    .status-label { font-weight:bold; font-size:12px; }
    .status-value { font-size:12px; }
    .status div { margin-bottom:2px; line-height:1.2; }
    .input-group { margin-bottom:30px; line-height:2.2em; }
    input { padding:10px; width:140px; border-radius:8px; border:1px solid #ccc; font-size:18px; text-align:center; }
    button.send { padding:10px 20px; border:none; border-radius:8px; background:#2980b9; color:#fff; font-weight:bold; font-size:16px; cursor:pointer; transition:0.3s; }
    button.send:hover { background:#3498db; }
    .buttons { display:flex; justify-content:space-around; gap:20px; margin-top:40px; }
    button#sprinklerBtn {
      padding:15px 30px; border:none; border-radius:12px; font-size:18px; font-weight:bold; cursor:pointer; color:#fff; flex:1; background-color:#27ae60;
      user-select:none; -webkit-user-select:none; touch-action:none; /* no accidental text selection/gestures */
    }
    button#sprinklerBtn:hover { opacity:0.9; }
    footer { margin-top:20px; font-size:14px; color:#555; }
    .gauge-row>div:last-child .bar-title { margin-left:-8px; }
    @media (max-width:600px){
      .dashboard { padding:20px; }
      .buttons { flex-direction:column; gap:15px; }
      button#sprinklerBtn { width:100%; }
      .gauge-row { flex-direction:row; gap:5px; justify-content:center; align-items:flex-end; }
      .moisture-canvas { width:180px; height:180px; }
      .temp-canvas { width:70px; height:180px; }
      .gauge-row .bar-title { font-size:16px; }
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <h2>SOIL-SYS DASHBOARD</h2>
    <div class="gauge-row">
      <div>
        <canvas id="moistureCanvas" class="moisture-canvas" width="250" height="250"></canvas>
        <div class="bar-title">Moisture</div>
      </div>
      <div>
        <canvas id="tempCanvas" class="temp-canvas" width="100" height="250"></canvas>
        <div class="bar-title">Temperature</div>
      </div>
    </div>

    <div class="status">
      <div><span class="status-label">System Status:</span> <span id="systemStatus" class="status-value" style="color:blue;">Unknown</span></div>
      <div><span class="status-label">Server Status:</span> <span id="mqttStatus" class="status-value" style="color:red;">Disconnected</span></div>
      <div><span class="status-label">Sprinkler Status:</span> <span id="pumpStatus" class="status-value">OFF</span></div>
      <div><span class="status-label">Runtime:</span> <span id="runtime" class="status-value">0</span> sec</div>
      <div><span class="status-label">Client ID:</span> <span id="clientIdText" class="status-value"></span></div>
    </div>

    <br/>

    <div class="input-group">
      <input type="number" id="runtimeInput" placeholder="Runtime (sec)">
      <button class="send" onclick="sendRuntime()">Send</button>
    </div>

    <div class="buttons">
      <button id="sprinklerBtn">SPRINKLER</button>
    </div>

    <footer>© 2025 Created by Engr. Clariden Montaño</footer>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const clientId = "WebClient" + Math.floor(Math.random() * 1000 + 1);
    document.getElementById("clientIdText").innerText = clientId;

    const client = mqtt.connect('wss://c33fda18bbcd4c9998277dfe166c7c4a.s1.eu.hivemq.cloud:8884/mqtt', {
      username: 'gwapooo',
      password: '_Mclards23',
      clientId: clientId,
      rejectUnauthorized: false
    });

    const topicJSON = "SoilSystem";
    const topicSprinkler = "Sprinkler";
    const topicSprinklerLong = "SprinklerLong";
    const topicRuntime = "Runtime";
    const topicLastWill = "Lastwill";

    const mqttStatusElem = document.getElementById('mqttStatus');
    const systemStatusElem = document.getElementById('systemStatus');
    const pumpStatusElem = document.getElementById('pumpStatus');
    const runtimeElem = document.getElementById('runtime');
    const runtimeInput = document.getElementById('runtimeInput');

    let currentMoisture = 0, targetMoisture = 0;
    let currentTemp = 0, targetTemp = 0;
    let sprinklerState = 0;

    client.on('connect', () => {
      mqttStatusElem.innerText = 'Connected';
      mqttStatusElem.style.color = 'green';
      client.subscribe(topicJSON);
      client.subscribe(topicLastWill);
      client.subscribe(topicSprinkler);
    });

    client.on('close',   () => { mqttStatusElem.innerText = 'Disconnected'; mqttStatusElem.style.color = 'red'; });
    client.on('offline', () => { mqttStatusElem.innerText = 'Offline';      mqttStatusElem.style.color = 'orange'; });
    client.on('error',   () => { mqttStatusElem.innerText = 'Error';        mqttStatusElem.style.color = 'red'; });

    client.on('message', (topic, message) => {
      if (topic === topicJSON) {
        const data = JSON.parse(message.toString());
        targetMoisture = data.moisture;
        targetTemp = data.temperature;
        pumpStatusElem.innerText = data.pumpRunning ? "ON" : "OFF";
        runtimeElem.innerText = data.runtime;
      } else if (topic === topicLastWill) {
        if (message.toString() === "System Online") {
          systemStatusElem.innerText = "Online";
          systemStatusElem.style.color = "green";
        } else {
          systemStatusElem.innerText = "Offline";
          systemStatusElem.style.color = "red";
        }
      } else if (topic === topicSprinkler) {
        const v = parseInt(message.toString(), 10) || 0;
        sprinklerState = v ? 1 : 0;
        sprinklerBtn.style.backgroundColor = sprinklerState ? "#27ae60" : "#c0392b";
      }
    });

    function sendRuntime() {
      const val = parseInt(runtimeInput.value);
      if (!isNaN(val) && val > 0) {
        client.publish(topicRuntime, val.toString(), { retain: true });
        runtimeInput.value = '';
        alert('Runtime sent: ' + val + ' sec');
      } else {
        alert('Enter a valid runtime in seconds');
      }
    }
    
    const sprinklerBtn = document.getElementById("sprinklerBtn");
    const LONG_MS = 600;

    let pressTimer = null;
    let isPointerDown = false;
    let longPressActive = false;

    function startPress(e) {
      e.preventDefault();
      isPointerDown = true;
      longPressActive = false;

      clearTimeout(pressTimer);
      pressTimer = setTimeout(() => {
        if (!isPointerDown) return;    
        longPressActive = true;
        client.publish(topicSprinklerLong, "1", { retain: false });
        sprinklerBtn.innerText = "HOLDING…";
        sprinklerBtn.style.backgroundColor = "#e67e22";
      }, LONG_MS);
    }

    function endPress(e) {
      if (!isPointerDown) return;  
      e.preventDefault();
      clearTimeout(pressTimer);

      if (longPressActive) {
        client.publish(topicSprinklerLong, "0", { retain: false });
        longPressActive = false;
        sprinklerBtn.innerText = "SPRINKLER";
        sprinklerBtn.style.backgroundColor = sprinklerState ? "#27ae60" : "#c0392b";
      } else {
        sprinklerState = 1;
        client.publish(topicSprinkler, sprinklerState.toString(), { retain: false });
        pumpStatusElem.innerText = sprinklerState ? "ON" : "OFF";
        sprinklerBtn.style.backgroundColor = sprinklerState ? "#27ae60" : "#c0392b";
      }

      isPointerDown = false;
    }

    function cancelPress() {
      clearTimeout(pressTimer);
      isPointerDown = false;

      if (longPressActive) {
        client.publish(topicSprinklerLong, "0", { retain: false });
        longPressActive = false;
        sprinklerBtn.innerText = "SPRINKLER";
        sprinklerBtn.style.backgroundColor = sprinklerState ? "#27ae60" : "#c0392b";
      }
    }

    sprinklerBtn.addEventListener("pointerdown", startPress);
    sprinklerBtn.addEventListener("pointerup", endPress);
    sprinklerBtn.addEventListener("pointerleave", () => { if (isPointerDown) endPress(new Event('pointerup')); });
    sprinklerBtn.addEventListener("pointercancel", cancelPress);
    sprinklerBtn.oncontextmenu = (e) => e.preventDefault(); 

    const canvas = document.getElementById('moistureCanvas');
    const ctx = canvas.getContext('2d');
    const radius = canvas.width / 2 - 20;

    const tempCanvas = document.getElementById('tempCanvas');
    const tctx = tempCanvas.getContext('2d');

    function interpolateColor(color1, color2, factor) {
      const result = color1.slice();
      for (let i = 0; i < 3; i++) result[i] = Math.round(result[i] + factor * (color2[i] - color1[i]));
      return result;
    }
    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      return [(bigint >> 16) & 255, (bigint >> 8) & 255, bigint & 255];
    }
    const dryColor = hexToRgb("#a0522d");
    const midColor = hexToRgb("#9acd32");
    const wetColor = hexToRgb("#1e90ff");
    function getMoistureColor(value) {
      if (value < 50) return interpolateColor(dryColor, midColor, value / 50);
      return interpolateColor(midColor, wetColor, (value - 50) / 50);
    }

    function drawMoisture() {
      const diff = targetMoisture - currentMoisture;
      currentMoisture += diff * 0.05;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const angle = (currentMoisture / 100) * 2 * Math.PI;

      const rgb = getMoistureColor(currentMoisture);
      const color = `rgb(${rgb[0]},${rgb[1]},${rgb[2]})`;

      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = '#eee';
      ctx.lineWidth = 30;
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, -Math.PI / 2, -Math.PI / 2 + angle);
      ctx.strokeStyle = color;
      ctx.lineWidth = 30;
      ctx.lineCap = 'round';
      ctx.stroke();

      ctx.fillStyle = '#111';
      ctx.font = 'bold 36px Segoe UI';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(Math.round(currentMoisture) + '%', centerX, centerY);

      requestAnimationFrame(drawMoisture);
    }

    function drawTemp() {
      const diff = targetTemp - currentTemp;
      currentTemp += diff * 0.05;

      tctx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);

      const gradient = tctx.createLinearGradient(0, tempCanvas.height - 20, 0, 0);
      gradient.addColorStop(0, "blue");
      gradient.addColorStop(1, "red");

      tctx.fillStyle = "#eee";
      tctx.fillRect(30, 0, 40, tempCanvas.height - 20);

      const fillHeight = (currentTemp / 50) * (tempCanvas.height - 20);
      tctx.fillStyle = gradient;
      tctx.fillRect(30, (tempCanvas.height - 20) - fillHeight, 40, fillHeight);

      tctx.fillStyle = "#111";
      tctx.font = "bold 16px Segoe UI";
      tctx.textAlign = "center";
      tctx.textBaseline = "top";
      tctx.fillText(Math.round(currentTemp) + "°C", tempCanvas.width / 2, tempCanvas.height - 18);

      requestAnimationFrame(drawTemp);
    }

    drawMoisture();
    drawTemp();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(() => console.log("Service Worker registered"));
    }
  </script>
</body>
</html>



